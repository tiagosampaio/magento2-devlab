#!/bin/bash

MAGE_VERSION=$1
FILENAME=$MAGE_VERSION.tar.gz
ARCHIVE_URL="https://github.com/tiagosampaio/magento-opensource-releases/archive"
DOWNLOAD_URL="$ARCHIVE_URL/$FILENAME"

[ -z "$MAGE_VERSION" ] && echo "Please specify the version to download (ex. 2.3.2)" && exit
#curl -L http://pubfiles.nexcess.net/magento/ce-packages/magento2-$1.tar.gz | tar xzf - -o -C .
# docker-compose exec php /bin/bash -c 'curl -L http://pubfiles.nexcess.net/magento/ce-packages/magento2-$1.tar.gz | tar xzf - -o -C /var/www/html/magento2'

VAR_DIR=".var"
MAGE_RELEASES_DIR="$VAR_DIR/magento/releases"

check_dir()
{
    if ! [[ -d "$VAR_DIR" ]]; then
        mkdir -p "$MAGE_RELEASES_DIR"
    fi
}

download()
{
    FINAL_FILE="$MAGE_RELEASES_DIR/$FILENAME"

    if ! [[ -f "$FINAL_FILE" ]]; then
        echo "Checking availability..."
        RESPONSE=$(curl -L -s -o /dev/null -w "%{HTTP_CODE}" "$DOWNLOAD_URL")

        if [ "$RESPONSE" == "404" ]; then
            echo "The version $MAGE_VERSION of Magento Open Source is not available for download."
            exit 0
        fi

        echo "Starting the download..."
        curl -L "$DOWNLOAD_URL" -o "$FINAL_FILE"
    else
        echo "The version $MAGE_VERSION of Magento Open Source is already downloaded."
    fi
}

check_dir
download
